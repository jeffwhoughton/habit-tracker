<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Tracker</title>
	<link rel="icon" type="image/x-icon" href="calicon.png">
	<meta name="viewport" content="width=device-width, user-scalable=0" />
	<link rel="stylesheet" href="style.css">
</head>
<body>

	<header>
		<button id="prevWeekBtn">&#9664;</button>
		<h1 id="weekDisplay">January 2025, W1</h1>
		<button id="nextWeekBtn">&#9654;</button>
	</header>

	<!-- === 3 Tabs: Today, Week, Health === -->
	<div class="tabs">
		<button id="todayTabBtn">Today</button>
		<button id="weekTabBtn" class="active">Week</button>
		<button id="healthTabBtn">Health</button>
	</div>

	<!-- === "Today" tab content (hidden by default) === -->
	<div id="todayTabContent" style="display: none; padding: 10px;">
		<!-- H2 will dynamically switch between "Things to do today:" and "Things to do on DATE:" -->
		<h2>Things to do today:</h2>
		<ul id="todayEntriesList"></ul>
	</div>

	<!-- === Table for Week/Health tabs === -->
	<table id="calendarTable">
		<thead>
			<tr>
				<th></th>
				<!-- Dates will be dynamically inserted here (Sun 29, Mon 30, etc.) -->
			</tr>
		</thead>
		<tbody>
			<!-- Category rows & data cells will be dynamically inserted here -->
		</tbody>
	</table>

	<button id="exportDataBtn">Export Data</button>


	<!-- ===== Modal for editing/adding entries ===== -->
	<div class="modal-backdrop" id="modalBackdrop">
		<div class="modal" id="entryModal">
			<button id="cancelBtn">✖</button>
			<h2 id="modalTitle">Edit Entries</h2>

			<!-- Container for previous entries -->
			<div id="previousEntries"></div>
			<br>
			<!-- New entry field(s) goes here -->
			<div id="newEntryWrap"></div>
			<textarea id="newEntryTitle" rows="2"></textarea>

			<button id="saveEntryBtn">Submit Text Entry</button><br><br>
		</div>
	</div>

	<script src="dateutils.js"></script>
	<script src="modal.js"></script> 
	<script src="export.js"></script> 
	<script>

	// Organize categories by tab:
	const categoriesByTab = {
		week: [
			"Weekly Goal",
			"Work",
			"Workout",
			"Reading",
			"Writing",
			"Coding",
			"Guitar",
			"TODOs"
		],
		health: [
			"Weight / BMI",
			"Spending",
			"Early Rise",
			"Screen Time",
			"Cals / Protein",
			"Alcohol",
			"Mood"
		]
	};

	// Which tab is currently selected?
	let selectedTab = "week"; // default

	// Data structure: For each dateKey -> category -> array of objects
	let calendarData = {};

	// We'll use today's date as a starting point
	let currentDate = new Date();

	// Attempt to load existing data from localStorage
	const savedData = localStorage.getItem("calendarData");
	if (savedData) {
		calendarData = JSON.parse(savedData);
	}

	// Some references to DOM elements
	const weekDisplay = document.getElementById("weekDisplay");
	const prevWeekBtn = document.getElementById("prevWeekBtn");
	const nextWeekBtn = document.getElementById("nextWeekBtn");
	const calendarTable = document.getElementById("calendarTable");
	const tbody = calendarTable.querySelector("tbody");

	// Tab buttons
	const todayTabBtn = document.getElementById("todayTabBtn");
	const weekTabBtn = document.getElementById("weekTabBtn");
	const healthTabBtn = document.getElementById("healthTabBtn");

	// "Today" tab content
	const todayTabContent = document.getElementById("todayTabContent");
	const todayEntriesList = document.getElementById("todayEntriesList");

	/********************************************************************
	 *  Helpers to decide row styling
	 ********************************************************************/
	function isWideCell(cat){
		return (
			cat === "Weight / BMI" ||
			cat === "Spending" ||
			cat === "Weekly Goal"
		);
	}

	function isTallCell(cat){
		return (
			cat === "TODOs" ||
			cat === "Mood" ||
			cat === "Journal"
		);
	}

	function shouldDisplayDescription(cat){
		return cat == "TODOs";
	}

	// For categories like "TODOs", we might add extra blank lines on certain days
	function howManyNewLinesToAdd(startOfWeek, cat, x){
		if (x == 0) return 0;

		const previousDateKey = formatDateKey(shiftDate(startOfWeek, x-1));
		const previousEntries = calendarData[previousDateKey]?.[cat] || [];

		const currentDateKey = formatDateKey(shiftDate(startOfWeek, x));
		const currentEntries = calendarData[currentDateKey]?.[cat] || [];

		const totalLines = previousEntries.length + howManyNewLinesToAdd(startOfWeek, cat, x-1);
		if (totalLines + currentEntries.length > 13) return 0;
		else return totalLines;
	}

	/********************************************************************
	 *  Core function to render the calendar (for Week/Health)
	 ********************************************************************/
	function renderCalendar(selectedDate) {
		// Only show the calendar if we're on week/health
		if (selectedTab === "today") {
			calendarTable.style.display = "none";
			return;
		} else {
			calendarTable.style.display = "";
		}

		const categories = categoriesByTab[selectedTab];
		const startOfWeek = getStartOfWeek(selectedDate);

		const monthName = getMonthName(startOfWeek);
		const year = startOfWeek.getFullYear();
		const weekNum = getWeekOfMonth(startOfWeek);

		weekDisplay.textContent = `${monthName} ${year}, W${weekNum}`;

		// Build date headers
		const theadRow = calendarTable.querySelector("thead tr");
		while (theadRow.children.length > 1) {
			theadRow.removeChild(theadRow.lastChild);
		}
		for (let i = 0; i < 7; i++) {
			const d = shiftDate(startOfWeek, i);
			const dayName = d.toLocaleString("default", { weekday: "short" });
			const dateNum = d.getDate();

			const th = document.createElement("th");
			// Highlight today's cell in header
			if (d.toDateString() === new Date().toDateString()) {
				th.style.outline = "1px solid black";
			}
			th.innerHTML = `${dayName}<br>${dateNum}`;
			th.addEventListener("click", () => {
				// Switch app to "Today" tab, set date to 'd'
				currentDate = d;
				activateTab("today");
			});
			theadRow.appendChild(th);
		}

		// Build category rows
		tbody.innerHTML = "";
		categories.forEach((cat) => {
			const row = document.createElement("tr");

			// Category cell
			const categoryFirstColumnCell = document.createElement("td");
			categoryFirstColumnCell.textContent = cat;
			row.appendChild(categoryFirstColumnCell);

			// 7 day cells
			for (let i = 0; i < 7; i++) {
				const d = shiftDate(startOfWeek, i);
				const dateKey = formatDateKey(d);

				const tdTableCell = document.createElement("td");
				if (isWideCell(cat) && i === 0) {
					tdTableCell.colSpan = 7;
				}
				tdTableCell.dataset.dateKey = dateKey;
				tdTableCell.dataset.category = cat;

				const catEntries = calendarData[dateKey]?.[cat] || [];

				const cellWrapper = document.createElement("div");
				if (isTallCell(cat)) {
					cellWrapper.classList.add("cell-wrapper-tall");
				} else {
					cellWrapper.classList.add("cell-wrapper-short");
					if (catEntries.length == 1){
						cellWrapper.style.display = "flex";
					}
				}

				// Possibly add new lines for "TODOs"
				if (isTallCell(cat) && shouldDisplayDescription(cat)) {
					let newLineCount = howManyNewLinesToAdd(startOfWeek, cat, i);
					for (let j = 0; j < newLineCount; j++) {
						const myBr = document.createElement("div");
						myBr.style.height = "13px";
						cellWrapper.appendChild(myBr);
					}
				}

				catEntries.forEach((entry, index) => {
					const cellContentEntry = document.createElement("div");
					if (shouldDisplayDescription(cat)) {
						cellContentEntry.classList.add("cell-content-overflow");
					} else {
						cellContentEntry.classList.add("cell-content-wrapped");
					}
					cellContentEntry.style.zIndex = 100-index;

					if (d.getDay() === 0 && cellContentEntry.classList.contains('cell-content-overflow')) {
						cellContentEntry.style.marginLeft = "-20px";
					}

					// Add newlines based on the current iteration index
					let displayText = "";

					if (isTallCell(cat) && shouldDisplayDescription(cat) && entry.description) {
						displayText = "<br>".repeat(index) +
							entry.title + " " +
							entry.description;
					} else {
						displayText = entry.title;						
					}
					tintEmoji(entry.title, cellContentEntry);

					cellContentEntry.innerHTML = displayText;
					cellWrapper.appendChild(cellContentEntry);
				});

				// Open modal on cell click
				tdTableCell.addEventListener("click", () => openModal(dateKey, cat));

				if (!isWideCell(cat) || i === 0) {
					tdTableCell.appendChild(cellWrapper);
					row.appendChild(tdTableCell);
				}
			}

			tbody.appendChild(row);
		});
	}

	/********************************************************************
	 *  1) "Today" tab rendering
	 *  2) Add click/tap toggle for each relevant entry
	 ********************************************************************/
	function renderTodayTab() {
		// Show/hide the appropriate content
		if (selectedTab === "today") {
			todayTabContent.style.display = "block";
			document.getElementById("exportDataBtn").style.display = "none";
			
			// -----------------------------
			//  Show the date in weekDisplay
			// -----------------------------
			weekDisplay.textContent = formatFriendlyDate(currentDate);

			// -----------------------------
			//  Update the H2 heading
			// -----------------------------
			const heading = todayTabContent.querySelector("h2");
			if (currentDate.toDateString() === new Date().toDateString()) {
				heading.textContent = "Things to do today:";
			} else {
				heading.textContent = "Things to do on " + formatFriendlyDate(currentDate) + ":";
			}

		} else {
			todayTabContent.style.display = "none";
			document.getElementById("exportDataBtn").style.display = "block";
			return; 
		}

		// Clear out the list
		todayEntriesList.innerHTML = "";

		const todayKey = formatDateKey(currentDate);
		const relevantTitles = ["⬜", "✅", "❌"];

		// Shift TODOs to the end:
	    const categoriesForToday = calendarData[todayKey] || {};
	    let categoryNames = Object.keys(categoriesForToday);
	    categoryNames = categoryNames.filter(name => name !== "TODOs");
	    if (categoriesForToday["TODOs"]) {
	        categoryNames.push("TODOs");
	    }

		// Loop through all categories in your calendarData[currentDateKey]
		for (let categoryName of categoryNames) {
			const entries = categoriesForToday[categoryName];

			entries.forEach((entry, idx) => {
				if (relevantTitles.includes(entry.title)) {
					
					// Decide the display text
					let displayText = "";
					if (categoryName === "TODOs") {
						displayText = `${entry.title} &nbsp;${entry.description || "(no description)"}`;
					} else {
						displayText = `${entry.title} &nbsp;${categoryName}`;
					}

					// Create an <li> for the "todayEntriesList"
					const li = document.createElement("li");
					li.innerHTML = displayText;

					/** 
					 * ===============================
					 *   CLICK HANDLER: CYCLE TITLE
					 * ===============================
					 */
					li.addEventListener("click", () => {
						const newTitle = getNextTitle(entry.title);
						entry.title = newTitle;

						// Save changes to localStorage
						localStorage.setItem("calendarData", JSON.stringify(calendarData));

						// Re-render to see updated titles
						renderCalendar(currentDate);
						renderTodayTab();
					});

					todayEntriesList.appendChild(li);
				}
			});
		}
	}

	/**
	 * Helper function to cycle through "⬜", "✅", "❌"
	 */
	function getNextTitle(currentTitle) {
		const cycle = ["⬜", "✅", "❌"];
		const currentIndex = cycle.indexOf(currentTitle);
		if (currentIndex === -1) {
			// If somehow not in the list, default to the first
			return cycle[0];
		} else {
			return cycle[(currentIndex + 1) % cycle.length];
		}
	}

	/********************************************************************
	 *  Tab switching
	 ********************************************************************/
	function activateTab(tabName) {
		selectedTab = tabName;

		// Update tab button styling (bold for the active one)
		todayTabBtn.classList.remove("active");
		healthTabBtn.classList.remove("active");
		weekTabBtn.classList.remove("active");

		if (tabName === "today") {
			todayTabBtn.classList.add("active");
		} else if (tabName === "health") {
			healthTabBtn.classList.add("active");
		} else {
			weekTabBtn.classList.add("active");
		}

		renderCalendar(currentDate);   // Re-render table if needed
		renderTodayTab();             // Also render today's list
	}

	todayTabBtn.addEventListener("click", () => {
		activateTab("today");
	});
	healthTabBtn.addEventListener("click", () => {
		activateTab("health");
	});
	weekTabBtn.addEventListener("click", () => {
		activateTab("week");
	});

	/********************************************************************
	 *  Prev/Next buttons
	 *    - Shift by 7 days if week/health
	 *    - Shift by 1 day if today
	 ********************************************************************/
	prevWeekBtn.addEventListener("click", () => {
		if (selectedTab === "today") {
			// Shift by -1 day
			currentDate = shiftDate(currentDate, -1);
			renderTodayTab();
		} else {
			// Shift by -7 days
			currentDate = shiftDate(currentDate, -7);
			renderCalendar(currentDate);
		}
	});

	nextWeekBtn.addEventListener("click", () => {
		if (selectedTab === "today") {
			// Shift by +1 day
			currentDate = shiftDate(currentDate, 1);
			renderTodayTab();
		} else {
			// Shift by +7 days
			currentDate = shiftDate(currentDate, 7);
			renderCalendar(currentDate);
		}
	});

	/********************************************************************
	 *  Initial render
	 ********************************************************************/
	renderCalendar(currentDate);
	renderTodayTab();

	</script>
</body>
</html>
